---

apiVersion: serving.knative.dev/v1alpha1
kind: Service

metadata:
  name: hello
  namespace: functions
  labels:
    app.kubernetes.io/name: hello

spec:
  runLatest:
    configuration:
      revisionTemplate:
        metadata:
          labels:
            app.kubernetes.io/name: hello
        spec:
          container:
            image: gcr.io/knative-samples/helloworld-go:latest
            env:
              - name: TARGET
                value: "world"

---

apiVersion: networking.istio.io/v1alpha3
kind: VirtualService

metadata:
  name: hello
  namespace: functions

spec:
  gateways: ["primary.istio-system"]
  hosts: ["fn.stevenxie.me"]
  http:
    - match:
        - uri:
            exact: /hello
      redirect:
        uri: /hello/
    - match:
        - uri:
            prefix: /hello/
      rewrite:
        uri: /
        authority: hello.functions.external
      route:
        - destination:
            host: istio-ingressgateway.istio-system.svc.cluster.local
            port:
              number: 80
          headers:
            response:
              set:
                X-Service: hello
