---

apiVersion: apps/v1
kind: Deployment

metadata:
  name: frps
  namespace: gateway
  annotations:
    flux.weave.works/automated: "true"
    flux.weave.works/tag.frp: semver:~0.26

spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: frps
  template:
    metadata:
      labels:
        app.kubernetes.io/name: frps
    spec:
      containers:
        - name: frp
          image: stevenxie/frp:0.26.0
          envFrom:
            - secretRef:
                name: frps
          ports:
            - name: bind
              containerPort: 7000
            - name: dashboard
              containerPort: 7500
            - name: https
              containerPort: 8443
            - name: ssh
              containerPort: 8022
            - name: ingress
              containerPort: 8000
          volumeMounts:
            - name: config
              mountPath: /etc/frp
          readinessProbe: &probe
            tcpSocket:
              port: bind
          livenessProbe: *probe
          resources:
            requests:
              cpu: 1m
              memory: 10Mi
            limits:
              cpu: 75m
              memory: 75Mi
      volumes:
        - name: config
          configMap:
            name: frps

---

apiVersion: v1
kind: ConfigMap

metadata:
  name: frps
  namespace: gateway

data:
  frps.ini: |
    [common]
    bind_port = 7000
    vhost_https_port = 8443
    dashboard_port = 7500
    dashboard_user = stevenxie
    dashboard_pwd = {{ .Envs.DASHBOARD_PASS }}
    token = {{ .Envs.TOKEN }}

---

apiVersion: bitnami.com/v1alpha1
kind: SealedSecret

metadata:
  name: frps
  namespace: gateway

spec:
  encryptedData:
    DASHBOARD_PASS: AgAI9x6MXr0TNFGn65u1ND2sr2RW0UgKw1i4TJDxaXqTgBfC35W5qCtx0Ya/SlLUaHy0Q4QkJLBCmRPAmVUgCX43Fey8QxUkqV/0ZJWYHh+6JktTSwdx78vEhlZ03rJ74lQE9WEym20dOpib3kk2dV+wtzV5VBeH3LHLIt5ZKpJ3CtYg+MgEFu9Cza8oGRdP88Jtwa03JyiIsGU9J/FiCUwHrldzJoXyy29WPA61HfHagOVg5RSHaWE1GUewGbSSodmuQYdvH5EnWTWCIRUnht+9UdVXU1iaj4PF/CycKeVQxp27apdcrPrPftEVE5UJMLjJ47Vc837PaJTIhSZytOXxhaFcpSOM8y7OjQ2CCwy9JMOyM7POh8570r+m9GFmctKpOmsll1nWS3KLSaLYKTcDBX9D7tgjbTeafEIXFlFRpAzoxaNI5ImQ6t5SC7hhV0Pk+wHooet2tRlssuzMvPthu2CZ2XQlGsG2aL1PxfHwBZBISE+qnKlimn96L0J/qJOLoboafceccY1rDK4O1DY8s6PhS+iaSqLmi65yLqRdLdO0eIRUn3VyYNesEHCtpPizfJicDXCPP32lW2ySPF5ax3NFfOxz75y5/8VV3/fnP09Q7ZTYlJzRRoh/tVwvFVnCexl80yTd1Wjs73Puf+Nb/sbcKwjZD85sNzBsRq3acwsxs8Csz15ZYdyN49a5Q6JeSZmCZZUL3X9L/A==
    TOKEN: AgC55VliQ40m0i+KglNGVn0/svqM0pv7A+tZn3qQVMC5Cb779Lz5aXb+JndZLGsER4nf8OWJbYsLZsEvW/esGs1FtWoV8KK4Z/KG+GgjTuccp3Js72WG3DAq+eVE/S5cJ4wBbSdU13r8aRJ5BylxneA+3viOGd96u2RKbOW/fn4euJe/Kq5kNFnDnxC+J3sWO3UkZTHmbwCGTKVT3ONG3apDbq8QAiCXqShqLRQXWZq1TM406x2WS+atWVELZkoqqSO5VDD4nk2A3odrf6TCM68QUy5z2Vl2dtr+VeYcc0jBn9SRz0sS7/gWunffBfYceznd2OU4w2tpUaoaFzX92BPMJvGdDg6kdbclTScKrofR7ct1f8waXdGQjaw6C+ISUajNIAyYAtbWnyxOTyhojFyNIwWNPIhH2amE+FhLHAtXesgm6rEsFtOKDfEaKix0Xlk3VTSonecIfUO5v2E+7mhvkid2o79+40lVpdF4ZXEDRnwkVqoFG9Pqf0CWxm+/YhEIYaEjqlZzeZX3+5cTpMs2K36yZBcmBt3mQKTZPOhUkCYKvNVDIrkoACjF4LT5mbyV/R1OV6uaToY/aHeJlfmrrHAFhAcnZOhLhqxxi3SvR5f3tfcK4fdl/UWySLEr5KBncu57msg1T91uUEg3fTBIdacV0IrEC+Kmh1idkKcIuyzlwBe9x6ECaDQ5/PVLZCJ1qJ9aRQ87zDmQnTyUz1vy0XxT4jUksSU/UBoq7fa+H5Sg/mPb3dIBzdaE8GAgReBA7vIOO1+JovdELR+IgWLk

---

apiVersion: v1
kind: Service

metadata:
  name: frps
  namespace: gateway
  labels:
    app.kubernetes.io/name: frps

spec:
  selector:
    app.kubernetes.io/name: frps
  ports:
    - name: bind
      port: 7000
      targetPort: bind
    - name: dashboard
      port: 7500
      targetPort: dashboard
    - name: https
      port: 443
      targetPort: https
    - name: ssh
      port: 22
      targetPort: ssh
    - name: ingress
      port: 80
      targetPort: 8000

---

apiVersion: networking.istio.io/v1alpha3
kind: VirtualService

metadata:
  name: frps
  namespace: gateway

spec:
  gateways: ["proxy"]
  hosts: ["frps.stevenxie.me"]
  tcp:
    - match:
        - port: 30070
      route:
        - destination:
            host: frps
            port:
              number: 7000
